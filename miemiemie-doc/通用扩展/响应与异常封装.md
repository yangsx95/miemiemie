# 响应与异常封装

## 响应对象的封装

在核心模块的`result`包下，存在类`Result`，用以代表请求所返回的响应，他的结构为：

```java
public class Result<T> {

    /**
     * 状态码
     */
    private int code;

    /**
     * 描述
     */
    private String message;

    /**
     * 数据对象
     */
    private T data;
}
```

其中状态码为`int`类型，描述为错误描述，而data是一个泛型，他可以是空，也可以是列表，也可以是一个对象。`Result`
是一个简单且基本的返回包装，在定义接口时，响应对象直接使用此类即可，比如：

```java
@GetMapping(value = "/users", produces = "application/json") // 设置返回类型，如果不设置，ui界面Response Content Type会显示 */*
public Result<List<User>>getUserList(){
        return Result.success(new ArrayList<>(users.values()));
        }
```

如果该接口不需要返回任何信息，可以使用`Void`作为借口的泛型：

```java
@PostMapping(value = "/open")
public Result<Void>open(){}
```

## 响应状态的封装

响应状态抽象为了一个`ResultStatus`接口，他继承了枚举抽象`CommonEnum`，因为响应状态就是枚举：

```java
public interface ResultStatus extends CommonEnum<Integer, String> {

    /**
     * 响应码
     *
     * @return 响应码
     */
    Integer getCode();

    /**
     * 响应描述
     *
     * @return 响应描述
     */
    String getMessage();
}
```

在框架中，我提供了一个默认的`ResultStatus`
枚举实现，只包含了一些简单的错误场景，如果你需要更多的响应状态，你可以继续增加`ResultStatus`实现，或者修改我的`ResultStatus`
实现：

```java

@Getter
@AllArgsConstructor
public enum ResultStatusEnum implements ResultStatus {

    /**
     * 成功状态
     */
    SUCCESS(200, "请求成功"),

    /**
     * 业务通用异常
     */
    BIZ_ERROR(300, "处理失败"),

    /**
     * 重复的请求
     */
    DUPLICATE_REQ(401, "不可重复的请求"),

    /**
     * 参数校验失败
     */
    PARAMETER_CHECK_FAIL(402, "参数校验失败"),

    /**
     * 认证失败
     */
    AUTH_FAIL(403, "认证失败"),

    /**
     * 系统未知错误
     */
    SERVER_ERROR(500, "服务器内部错误"),

    /**
     * 服务器繁忙
     */
    SERVER_BUSY(511, "服务器繁忙，请稍后再试"),

    // ......

    ;

    private final Integer code;


    private final String message;
}
```

在返回响应时，可以指定响应状态再返回：

```java
Result.fail(ResultStatusEnum.BIZ_ERROR);
```

## 异常的封装

在核心包中，同样有针对异常进行封装，目前有一个简单的业务异常 `BizException` 定义于核心模块的`exception`
包下，异常对象实际上也是一种响应对象，在`BizException` 创建时，需要接收异常信息（也就是响应信息）：

```java
public BizException(ResultStatus resultStatus);
public BizException(ResultStatus errorInfoInterface,Throwable cause);
public BizException(int errorCode,String errorMsg);
public BizException(String errorMsg);
```

## web项目支持-统一异常处理器

在`miemiemie-web`下，定义了一个名称为 `GlobalExceptionHandler`
的自定义异常处理器，注意，他只能去处理restful请求。该异常处理器会处理所有的异常，并包装为`Result`对象返回：

| 可处理的异常类型                        | 返回的响应状态                           |
|---------------------------------|-----------------------------------|
| MethodArgumentNotValidException | PARAMETER_CHECK_FAIL(402, 参数校验失败) |
| BindException                   | PARAMETER_CHECK_FAIL(402, 参数校验失败) |
| BizException                    | 根据异常对象决定                          |
| RuntimeException                | SERVER_ERROR(500, 服务器内部错误)        |
| Exception                       | SERVER_ERROR(500, 服务器内部错误)        |

此外，针对validator的校验错误，额外提供了`ValidationExceptionHandler`类处理，具体请参考参数校验模块文档。
